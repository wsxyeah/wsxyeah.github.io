<!DOCTYPE html><html lang="default"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> No more magic - React Redux · 王少星的个人博客</title><meta name="description" content="No more magic - React Redux - 王少星"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://wsxyeah.github.io/atom.xml" title="王少星的个人博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">No more magic - React Redux</h1><div class="post-info">Jul 15, 2017</div><div class="post-content"><p>Redux 作为一个状态管理工具，Redux 库本身仅负责状态管理，职责就很纯粹，而与 View 层粘合的部分（比如本文要讲的 React Redux）则单独拆出来。这使做它可以灵活地与多种 View 层实现组合使用，这一点很值得学习。</p>
<p>本文将解析胶水 React Redux 背后的 magic。</p>
<a id="more"></a>
<h2 id="使用-React-Redux-的一般姿势"><a href="#使用-React-Redux-的一般姿势" class="headerlink" title="使用 React Redux 的一般姿势"></a>使用 React Redux 的一般姿势</h2><p>Redux 官方文档给出了使用 React Redux 来给 React 集成 Redux 的用法。</p>
<p>根据文档，整体思想是由一个顶级的容器组件来持有和管理 state，子组件作为展示型组件，接受父组件传递的 props 并 render 出来。当然，这些 props 最终来源于容器组件所持有的的全局 state。</p>
<p>首先看官方的示例代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">render(</div><div class="line">  &lt;Provider store=&#123;store&#125;&gt;</div><div class="line">    &lt;App /&gt;</div><div class="line">  &lt;/Provider&gt;,</div><div class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</div><div class="line">)</div></pre></td></tr></table></figure>
<p>Provider 的角色就是上文中的容器组件。这里将 Provider 作为顶级组件，并将 store 作为 props 传递给它。</p>
<p>再来看对子组件的包装</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> VisibleTodoList = connect(</div><div class="line">  mapStateToProps,</div><div class="line">  mapDispatchToProps</div><div class="line">)(TodoList)</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> VisibleTodoList</div></pre></td></tr></table></figure>
<p>对子组件的包装通过 <code>connect</code> 函数来实现，先传递 <code>mapStateToProps</code>，<code>mapDispatchToProps</code> 给 <code>connect</code> 得到一个新的函数，再把子组件传进去得到包装后的组件。这个包装出来的组件就会在合适的时机通过某种魔法调用 <code>mapStateToProps</code>，<code>mapDispatchToProps</code> 并将结果作为 props 传递给子组件，这样子组件就可以访问全局 state，或者 dispatch action 了。</p>
<p>其实这里 <code>connect</code> 相关的部分就是高阶组件（Higher Order Component）的角色，它是一个函数，接受组件作为参数，并返回包装后的组件。我们通过 ReactDevTools 可以探查到生成的组件是直接包在我们原来的组件外面的，比如我们有一个叫 Home 的组件，返回的组件树如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;Connect(Home)&gt;</div><div class="line">  &lt;Home/&gt;</div><div class="line">&lt;/Connect&gt;</div></pre></td></tr></table></figure>
<p>那么根据 React Redux 的用法，我们主要的关注点就是两个：<code>Provider</code> 组件与 <code>connect</code> 函数。</p>
<h2 id="Provider-组件"><a href="#Provider-组件" class="headerlink" title="Provider 组件"></a>Provider 组件</h2><p><code>Provider</code> 组件由 <code>createProvider</code> 函数创建。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Provider.js</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createProvider</span>(<span class="params">storeKey = <span class="string">'store'</span>, subKey</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> subscriptionKey = subKey || <span class="string">`<span class="subst">$&#123;storeKey&#125;</span>Subscription`</span></div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">        getChildContext() &#123;</div><div class="line">          <span class="keyword">return</span> &#123; [storeKey]: <span class="keyword">this</span>[storeKey], [subscriptionKey]: <span class="literal">null</span> &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">constructor</span>(props, context) &#123;</div><div class="line">          <span class="keyword">super</span>(props, context)</div><div class="line">          <span class="keyword">this</span>[storeKey] = props.store;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        render() &#123;</div><div class="line">          <span class="keyword">return</span> Children.only(<span class="keyword">this</span>.props.children)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Provider.propTypes = &#123;</div><div class="line">        <span class="attr">store</span>: storeShape.isRequired,</div><div class="line">        <span class="attr">children</span>: PropTypes.element.isRequired,</div><div class="line">    &#125;</div><div class="line">    Provider.childContextTypes = &#123;</div><div class="line">        [storeKey]: storeShape.isRequired,</div><div class="line">        [subscriptionKey]: subscriptionShape,</div><div class="line">    &#125;</div><div class="line">    Provider.displayName = <span class="string">'Provider'</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> Provider</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> createProvider()</div></pre></td></tr></table></figure>
<p>那么这里的重点就是 <code>getChildContext</code> 方法，它的返回值包含了对 store 的引用。<code>Provider</code> 就是通过 <code>getChildContext</code> 来向组件树提供 context（store）的。</p>
<p>关于 context，它的作用是向下传递数据，与 props 相比，context 不需要一级一级地手动传下去，而下面的<strong>任何组件</strong>都能够通过 <code>this.context</code> 直接访问 context。</p>
<p>官方文档对 context 有更加详细的解释（<a href="https://facebook.github.io/react/docs/context.html" target="_blank">Context</a>）。</p>
<h2 id="connect-函数"><a href="#connect-函数" class="headerlink" title="connect 函数"></a>connect 函数</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// createConnect with default args builds the 'official' connect behavior. Calling it with</span></div><div class="line"><span class="comment">// different options opens up some testing and extensibility scenarios</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createConnect</span>(<span class="params">&#123;</span></span></div><div class="line">  connectHOC = connectAdvanced,</div><div class="line">  mapStateToPropsFactories = defaultMapStateToPropsFactories,</div><div class="line">  mapDispatchToPropsFactories = defaultMapDispatchToPropsFactories,</div><div class="line">  mergePropsFactories = defaultMergePropsFactories,</div><div class="line">  selectorFactory = defaultSelectorFactory</div><div class="line">&#125; = &#123;&#125;) &#123;</div><div class="line">  <span class="comment">// 这里就是 connect 函数了</span></div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span></span></div><div class="line">    mapStateToProps,</div><div class="line">    mapDispatchToProps,</div><div class="line">    mergeProps,</div><div class="line">    &#123;</div><div class="line">      pure = true,</div><div class="line">      areStatesEqual = strictEqual,</div><div class="line">      areOwnPropsEqual = shallowEqual,</div><div class="line">      areStatePropsEqual = shallowEqual,</div><div class="line">      areMergedPropsEqual = shallowEqual,</div><div class="line">      ...extraOptions</div><div class="line">    &#125; = &#123;&#125;</div><div class="line">  ) &#123;</div><div class="line">    <span class="keyword">const</span> initMapStateToProps = match(mapStateToProps, mapStateToPropsFactories, <span class="string">'mapStateToProps'</span>)</div><div class="line">    <span class="keyword">const</span> initMapDispatchToProps = match(mapDispatchToProps, mapDispatchToPropsFactories, <span class="string">'mapDispatchToProps'</span>)</div><div class="line">    <span class="keyword">const</span> initMergeProps = match(mergeProps, mergePropsFactories, <span class="string">'mergeProps'</span>)</div><div class="line"></div><div class="line">    <span class="comment">// 返回 connectHOC 调用的结果</span></div><div class="line">    <span class="keyword">return</span> connectHOC(selectorFactory, &#123;</div><div class="line">      <span class="comment">// used in error messages</span></div><div class="line">      methodName: <span class="string">'connect'</span>,</div><div class="line"></div><div class="line">       <span class="comment">// used to compute Connect's displayName from the wrapped component's displayName.</span></div><div class="line">      getDisplayName: <span class="function"><span class="params">name</span> =&gt;</span> <span class="string">`Connect(<span class="subst">$&#123;name&#125;</span>)`</span>,</div><div class="line"></div><div class="line">      <span class="comment">// if mapStateToProps is falsy, the Connect component doesn't subscribe to store state changes</span></div><div class="line">      shouldHandleStateChanges: <span class="built_in">Boolean</span>(mapStateToProps),</div><div class="line"></div><div class="line">      <span class="comment">// passed through to selectorFactory</span></div><div class="line">      initMapStateToProps,</div><div class="line">      initMapDispatchToProps,</div><div class="line">      initMergeProps,</div><div class="line">      pure,</div><div class="line">      areStatesEqual,</div><div class="line">      areOwnPropsEqual,</div><div class="line">      areStatePropsEqual,</div><div class="line">      areMergedPropsEqual,</div><div class="line"></div><div class="line">      <span class="comment">// any extra options args can override defaults of connect or connectAdvanced</span></div><div class="line">      ...extraOptions</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> createConnect()</div></pre></td></tr></table></figure>
<p><code>connect</code> 通过 <code>createConnect()</code> 创建出来，<code>connect</code> 的核心实现在 <code>connectHOC</code>（即<code>connectAdvanced</code>）里。</p>
<p><code>connectAdvanced</code> 返回了函数 <code>function wrapWithConnect(WrappedComponent)</code>，也就是说这个 <code>WrappedComponent</code>就是我们自己的组件，而 <code>wrapWithConnect</code> 返回了一个 <code>Connect</code> 组件，它就是最终包装得到的组件。</p>
<p>在 Redux 中，我们要拿到 store 的 state，就应该先去 subscribe 这个 store，然后在 state 更新之后得到通知。我们的组件要想在 state 更新时得到通知，就得靠 <code>Connect</code> 先订阅 store，然后传 props 过来。所以这个 <code>Connect</code> 的实现也是八九不离十了，它应该是先订阅了 store，在 state 更新后再调用 <code>mapStateToProps</code> 和 <code>mapDispatchToProps</code>，组合之后作为 props 传给子组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">addExtraProps(props) &#123;</div><div class="line">  <span class="keyword">if</span> (!withRef &amp;&amp; !renderCountProp &amp;&amp; !(<span class="keyword">this</span>.propsMode &amp;&amp; <span class="keyword">this</span>.subscription)) <span class="keyword">return</span> props</div><div class="line"></div><div class="line">  <span class="keyword">const</span> withExtras = &#123; ...props &#125;</div><div class="line">  <span class="keyword">if</span> (withRef) withExtras.ref = <span class="keyword">this</span>.setWrappedInstance</div><div class="line">  <span class="keyword">if</span> (renderCountProp) withExtras[renderCountProp] = <span class="keyword">this</span>.renderCount++</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.propsMode &amp;&amp; <span class="keyword">this</span>.subscription) withExtras[subscriptionKey] = <span class="keyword">this</span>.subscription</div><div class="line">  <span class="keyword">return</span> withExtras</div><div class="line">&#125;</div><div class="line"></div><div class="line">render() &#123;</div><div class="line">  <span class="keyword">const</span> selector = <span class="keyword">this</span>.selector</div><div class="line">  selector.shouldComponentUpdate = <span class="literal">false</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> (selector.error) &#123;</div><div class="line">    <span class="keyword">throw</span> selector.error</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// 给子组件加了 selector.props 属性，</span></div><div class="line">    <span class="comment">// 也就是 mapStateToProps, mapDispatchToProps 返回的东西</span></div><div class="line">    <span class="keyword">return</span> createElement(WrappedComponent, <span class="keyword">this</span>.addExtraProps(selector.props))</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeSelectorStateful</span>(<span class="params">sourceSelector, store</span>) </span>&#123;</div><div class="line">  <span class="comment">// wrap the selector in an object that tracks its results between runs.</span></div><div class="line">  <span class="keyword">const</span> selector = &#123;</div><div class="line">    <span class="attr">run</span>: <span class="function"><span class="keyword">function</span> <span class="title">runComponentSelector</span>(<span class="params">props</span>) </span>&#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">const</span> nextProps = sourceSelector(store.getState(), props)</div><div class="line">        <span class="keyword">if</span> (nextProps !== selector.props || selector.error) &#123;</div><div class="line">          selector.shouldComponentUpdate = <span class="literal">true</span></div><div class="line">          selector.props = nextProps</div><div class="line">          selector.error = <span class="literal">null</span></div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</div><div class="line">        selector.shouldComponentUpdate = <span class="literal">true</span></div><div class="line">        selector.error = error</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> selector</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connect</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(props, context) &#123;</div><div class="line">    <span class="keyword">super</span>(props, context)</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.state = &#123;&#125;</div><div class="line">    <span class="keyword">this</span>.renderCount = <span class="number">0</span></div><div class="line">    <span class="comment">// 从 props 或 context 里取出 store</span></div><div class="line">    <span class="keyword">this</span>.store = props[storeKey] || context[storeKey]</div><div class="line">    <span class="keyword">this</span>.propsMode = <span class="built_in">Boolean</span>(props[storeKey])</div><div class="line">    <span class="keyword">this</span>.setWrappedInstance = <span class="keyword">this</span>.setWrappedInstance.bind(<span class="keyword">this</span>)</div><div class="line"></div><div class="line">    <span class="comment">// 初始化 this.selector</span></div><div class="line">    <span class="keyword">this</span>.initSelector()</div><div class="line">    <span class="comment">// 订阅 store</span></div><div class="line">    <span class="keyword">this</span>.initSubscription()</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  initSelector() &#123;</div><div class="line">    <span class="keyword">const</span> sourceSelector = selectorFactory(<span class="keyword">this</span>.store.dispatch, selectorFactoryOptions)</div><div class="line">    <span class="comment">// 方法定义见上面</span></div><div class="line">    <span class="comment">// 返回的对象 selector 对象包含一个 run 方法，</span></div><div class="line">    <span class="comment">// run 方法会调用 selector 函数计算出新的 props，并把 props 作为属性暴露出来，</span></div><div class="line">    <span class="comment">// 也就是 render 方法中所读取的 selector.props</span></div><div class="line">    <span class="keyword">this</span>.selector = makeSelectorStateful(sourceSelector, <span class="keyword">this</span>.store)</div><div class="line">    <span class="keyword">this</span>.selector.run(<span class="keyword">this</span>.props)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  initSubscription() &#123;</div><div class="line">    <span class="keyword">if</span> (!shouldHandleStateChanges) <span class="keyword">return</span></div><div class="line"></div><div class="line">    <span class="keyword">const</span> parentSub = (<span class="keyword">this</span>.propsMode ? <span class="keyword">this</span>.props : <span class="keyword">this</span>.context)[subscriptionKey]</div><div class="line">    <span class="comment">// Subscription 是用来管理订阅的一个工具类，这里的 onStateChange 函数会接收 state 更新</span></div><div class="line">    <span class="keyword">this</span>.subscription = <span class="keyword">new</span> Subscription(<span class="keyword">this</span>.store, parentSub, <span class="keyword">this</span>.onStateChange.bind(<span class="keyword">this</span>))</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.notifyNestedSubs = <span class="keyword">this</span>.subscription.notifyNestedSubs.bind(<span class="keyword">this</span>.subscription)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  componentDidMount() &#123;</div><div class="line">    <span class="keyword">if</span> (!shouldHandleStateChanges) <span class="keyword">return</span></div><div class="line"></div><div class="line">    <span class="keyword">this</span>.subscription.trySubscribe()</div><div class="line">    <span class="keyword">this</span>.selector.run(<span class="keyword">this</span>.props)</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.selector.shouldComponentUpdate) <span class="keyword">this</span>.forceUpdate()</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  componentWillReceiveProps(nextProps) &#123;</div><div class="line">    <span class="keyword">this</span>.selector.run(nextProps)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  shouldComponentUpdate() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.selector.shouldComponentUpdate</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  componentWillUnmount() &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.subscription) <span class="keyword">this</span>.subscription.tryUnsubscribe()</div><div class="line">    <span class="keyword">this</span>.subscription = <span class="literal">null</span></div><div class="line">    <span class="keyword">this</span>.notifyNestedSubs = noop</div><div class="line">    <span class="keyword">this</span>.store = <span class="literal">null</span></div><div class="line">    <span class="keyword">this</span>.selector.run = noop</div><div class="line">    <span class="keyword">this</span>.selector.shouldComponentUpdate = <span class="literal">false</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// state 有更新</span></div><div class="line">  onStateChange() &#123;</div><div class="line">    <span class="comment">// 计算 selector.props</span></div><div class="line">    <span class="keyword">this</span>.selector.run(<span class="keyword">this</span>.props)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.selector.shouldComponentUpdate) &#123;</div><div class="line">      <span class="keyword">this</span>.notifyNestedSubs()</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">this</span>.componentDidUpdate = <span class="keyword">this</span>.notifyNestedSubsOnComponentDidUpdate</div><div class="line">      <span class="comment">// 调用 setState 触发 render</span></div><div class="line">      <span class="keyword">this</span>.setState(dummyState)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  notifyNestedSubsOnComponentDidUpdate() &#123;</div><div class="line">    <span class="keyword">this</span>.componentDidUpdate = <span class="literal">undefined</span></div><div class="line">    <span class="keyword">this</span>.notifyNestedSubs()</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，<code>Connect</code> 订阅了 store，并在 <code>onStateChange</code> 中令 selector 重新计算 props，之后 setState 触发组件的 render，使子组件的 props 得到更新。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://redux.js.org/docs/basics/UsageWithReact.html" target="_blank">Redux Usage with React</a></li>
<li></li>
<li><a href="https://facebook.github.io/react/docs/context.html" target="_blank">React Context</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2017/05/20/Microsoft-Word-Skills/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="https://wsxyeah.github.io">王少星</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>