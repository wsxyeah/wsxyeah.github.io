<!DOCTYPE html><html lang="default"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 浅谈 Android 事件分发机制 · 王少星的个人博客</title><meta name="description" content="浅谈 Android 事件分发机制 - 王少星"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://wsxyeah.github.io/atom.xml" title="王少星的个人博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">浅谈 Android 事件分发机制</h1><div class="post-info">Apr 3, 2016</div><div class="post-content"><h2 id="1-形式"><a href="#1-形式" class="headerlink" title="1. 形式"></a>1. 形式</h2><p>Touch 事件被封装成 MotionEvent 对象来传递。<br>由 ACTION_DOWN 开始，经过若干次 ACTION_MOVE 并以 ACTION_UP 结束的一个事件序列称为一个 gesture。</p>
<h2 id="2-角色"><a href="#2-角色" class="headerlink" title="2. 角色"></a>2. 角色</h2><p>涉及 Touch 事件处理的角色有四种：</p>
<ul>
<li>Activity</li>
<li>Window</li>
<li>ViewGroup</li>
<li>View</li>
</ul>
<a id="more"></a>
<h2 id="3-基本流程"><a href="#3-基本流程" class="headerlink" title="3. 基本流程"></a>3. 基本流程</h2><p>事件在 activity 中的分发起始于 <code>dispatchTouchEvent()</code> 方法。从源码可以看出 activity 调用了 Window 的 <code>superDispatchTouchEvent()</code> 方法来处理，若返回值为 true，则结束事件分发，否则调用 <code>onTouchEvent()</code>  方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (ev.getAction() == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">		onUserInteraction();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (getWindow().superDispatchTouchEvent(ev)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> onTouchEvent(ev);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Window 的实现类为 PhoneWindow，PhoneWindow 实际调用了 DecorView 的 <code>superDispatchTouchEvent()</code>。<br>而 DecorView 是 activity 中的顶级 View，它其实是一个 FrameLayout，它的 <code>superDispatchTouchEvent()</code> 直接调用了 ViewGroup 的 <code>dispatchTouchEvent()</code>。</p>
<p>由此，事件流入 View 层级。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// PhoneWindow</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> mDecor.superDispatchTouchEvent(event);</div><div class="line">&#125;</div><div class="line"><span class="comment">// DecorView</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-ViewGroup-dispatchTouchEvent-流程"><a href="#4-ViewGroup-dispatchTouchEvent-流程" class="headerlink" title="4. ViewGroup dispatchTouchEvent() 流程"></a>4. ViewGroup <code>dispatchTouchEvent()</code> 流程</h2><p>事件流入 View 层级后会逐级分发，ViewGroup 处在事件分发的中间层，是事件分发机制中最复杂的部分。此处源码非常长，就不贴出来了。</p>
<p>ACTION_DOWN 事件作为一次 gesture 的开始，可以影响后续事件的传递流程。为了方便理解，这里将它与其他类型的事件分开分析。</p>
<ul>
<li>对于 ACITON_DOWN 事件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</div><div class="line">	</div><div class="line">	<span class="comment">// 1. 作为一次 gesture 的开始，重置状态</span></div><div class="line">	</div><div class="line">	<span class="comment">// 2. 判断是否需要拦截本次事件</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</div><div class="line">	<span class="keyword">if</span> (!disallowIntercept) &#123;</div><div class="line">		<span class="comment">// 此时 disallowIntercept 已被重置为 false，onInterceptTouchEvent 一定会被调用</span></div><div class="line">		intercepted = onInterceptTouchEvent(ev);</div><div class="line">		ev.setAction(action); <span class="comment">// restore action in case it was changed</span></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		intercepted = <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (!intercepted &amp;&amp; mChildrenCount != <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// 3.a 不进行拦截的情况，向下分发</span></div><div class="line">	 	<span class="comment">// 从前面到后面遍历子 View，这里用循环仅简单表示遍历过程</span></div><div class="line">	 	<span class="keyword">for</span> (View child : mChildren) &#123;</div><div class="line">	 		<span class="keyword">if</span> (!canViewReceivePointerEvents(child)</div><div class="line">				|| !isTransformedTouchPointInView(x, y, child, <span class="keyword">null</span>)) &#123;</div><div class="line">				<span class="comment">// 该子 View 不可见或触摸位置不在子 View 边界内，跳过</span></div><div class="line">				<span class="keyword">continue</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 变换 MotionEvent 并传给子 View 的 dispatchTouchEvent</span></div><div class="line">			<span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</div><div class="line">				<span class="comment">// 若返回 true，表示该子 View 需要处理此次 gesture 的事件，记录此状态</span></div><div class="line">				handled = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">	 	&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// 3.b 进行拦截的情况，需要自己处理事件</span></div><div class="line">		handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>对于非 ACITON_DOWN 事件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</div><div class="line">	</div><div class="line">	<span class="comment">// 1. 判断是否需要拦截本次事件</span></div><div class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</div><div class="line">	<span class="keyword">if</span> (!disallowIntercept) &#123;</div><div class="line">		intercepted = onInterceptTouchEvent(ev);</div><div class="line">		ev.setAction(action); <span class="comment">// restore action in case it was changed</span></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// 若之前子 View 调用了 requestDisallowInterceptTouchEvent(true)，则不允许拦截</span></div><div class="line">		intercepted = <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (!intercepted &amp;&amp; mChildrenCount != <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">// 2.a 不进行拦截的情况，向下分发</span></div><div class="line">	 	<span class="comment">// 仅遍历之前记录的子 View（即对 ACTION_DOWN 事件返回 true 的子 View）</span></div><div class="line">	 	<span class="comment">// 这里循环仅简单表示遍历过程，实际上源码是使用链表实现的</span></div><div class="line">	 	<span class="keyword">for</span> (View child : children) &#123;</div><div class="line">			<span class="comment">// 变换 MotionEvent 并传给子 View 的 dispatchTouchEvent</span></div><div class="line">			<span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</div><div class="line">				handled = <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">	 	&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// 2.b 进行拦截的情况，需要自己处理事件</span></div><div class="line">		handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> handled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="5-View-dispatchTouchEvent-流程"><a href="#5-View-dispatchTouchEvent-流程" class="headerlink" title="5. View dispatchTouchEvent() 流程"></a>5. View <code>dispatchTouchEvent()</code> 流程</h2><p>View 位于事件分发的最下层，不再向下分发。View 的事件分发逻辑大致等效于 <code>return mOnTouchListener.onTouch(this, e) || onTouchEvent(e);</code>。</p>
<p>View 的 OnClickListener 是在 <code>onTouchEvent()</code> 方法里回调的，所以如果我们为 View 设置了 onTouchListener 并在 <code>onTouch()</code> 里返回 true，那么它的 OnClick 等系统预设的事件会失效。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 简化的 View dispatchTouchEvent 代码</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">	<span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">	ListenerInfo li = mListenerInfo;</div><div class="line">	<span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></div><div class="line"> 		&amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class="line">		&amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</div><div class="line">		result = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</div><div class="line">		result = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2016/05/22/ubuntu-samba-service/" class="prev">上一篇</a><a href="/2016/03/13/date-format/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2017 <a href="https://wsxyeah.github.io">王少星</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>